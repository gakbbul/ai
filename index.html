<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>각뿔봇 챗봇</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow: hidden; /* Prevent body scroll */
        }
        /* Custom styles for bouncing dots loading animation */
        .animate-bounce-dot {
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .animate-bounce-dot:nth-child(1) { animation-delay: -0.32s; }
        .animate-bounce-dot:nth-child(2) { animation-delay: -0.16s; }
        .animate-bounce-dot:nth-child(3) { animation-delay: 0s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        /* Style for modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            overflow-y: auto; /* Allow scrolling within the overlay */
            padding: 1rem; /* Add padding for small screens */
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem; /* rounded-lg */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            max-width: 90%;
            max-height: 90vh; /* Max height to prevent overflow on small screens */
            overflow-y: auto; /* Allow scrolling within the modal content */
            position: relative;
        }
        .modal-content h1 {
            font-size: 2.5rem; /* text-4xl */
            font-weight: 700; /* font-bold */
            margin-bottom: 1.5rem;
            color: #1f2937; /* text-gray-900 */
        }
        .modal-content h2 {
            font-size: 1.75rem; /* text-2xl */
            font-weight: 600; /* font-semibold */
            margin-top: 2rem;
            margin-bottom: 1rem;
            color: #1f2937;
        }
        .modal-content ul {
            list-style-type: disc;
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }
        .modal-content li {
            margin-bottom: 0.5rem;
        }
        .modal-content strong {
            font-weight: 700;
        }
    </style>
</head>
<body class="flex flex-col h-screen bg-gray-100 antialiased">
    <!-- 변경 사항 내용을 여기에 직접 작성하세요. (HTML 형식) -->
    <div id="changelog-data" class="hidden">
        <h2>v22 (2025년 7월 13일)</h2>
        <ul>
            <li><strong>프로필 기능 추가:</strong> 각뿔봇에게 네 이름과 알려주고 싶은 점을 저장할 수 있는 프로필 기능이 생겼각.</li>
            <li><strong>개인화된 답변:</strong> 각뿔봇이 네 프로필 정보를 기억해서 더 맞춤형으로 대답해줄 거각.</li>
            <li><strong>프로필 정보 저장 방식 변경:</strong> 프로필 정보는 이제 브라우저를 닫아도 사라지지 않고 기억될 거각. 대화 기록은 여전히 브라우저 탭을 닫으면 사라져각.</li>
            <li><strong>버전 업데이트:</strong> `v21`에서 `v22`로 변경했각.</li>
        </ul>

        <h2>v21 (2025년 7월 13일)</h2>
        <ul>
            <li><strong>단일 페이지 변경 사항 구현:</strong> '변경 사항' 버튼 클릭 시 새 페이지로 이동하는 대신, 현재 페이지 내에서 모달 창으로 변경 이력을 표시하도록 수정했각.</li>
            <li><strong>메뉴 버튼 활성화 색상:</strong> 메뉴가 열렸을 때 메뉴 버튼의 배경색이 `bg-gray-600`으로 연하게 변경되도록 수정했각.</li>
        </ul>

        <h2>v20 (2025년 7월 13일)</h2>
        <ul>
            <li><strong>메뉴 버튼 시각 피드백 추가:</strong> 왼쪽 상단 메뉴 버튼 클릭 시 색상이 연하게 변경되도록 수정했각.</li>
            <li><strong>'변경 사항' 버튼 추가:</strong> 메뉴 드롭다운에 '변경 사항' 버튼을 추가했각.</li>
            <li><strong>'변경 사항' 페이지 구현:</strong> '변경 사항' 버튼 클릭 시 별도의 페이지로 이동하여 변경 이력을 볼 수 있도록 했각.</li>
            <li><strong>'보내각' 버튼 텍스트 줄바꿈 방지:</strong> 모바일 환경에서 '보내각' 버튼 텍스트가 세로로 표시되는 문제 해결을 위해 `whitespace-nowrap` 스타일을 추가했각.</li>
        </ul>

        <h2>v19 (2025년 7월 13일)</h2>
        <ul>
            <li><strong>Firebase 제거 및 SessionStorage 적용:</strong> 대화 기록 저장 방식을 Firebase에서 SessionStorage로 변경했각. 이제 브라우저 탭을 닫으면 대화 기록이 초기화돼각.</li>
            <li><strong>Firebase 오류 메시지 제거:</strong> Firebase 관련 오류 메시지가 더 이상 표시되지 않아각.</li>
            <li><strong>버전명 업데이트:</strong> 'beta/' 접두사를 제거하고 버전명을 'v19'로 변경했각.</li>
        </ul>

        <h2>v18 (2025년 7월 13일)</h2>
        <ul>
            <li><strong>API 키 업데이트:</strong> 사용자 제공 Gemini API 키를 코드에 적용했각.</li>
            <li><strong>API 오류 메시지 개선:</strong> Gemini API 통신 오류 시 사용자에게 더 자세한 오류 메시지를 표시하도록 개선했각.</li>
        </ul>

        <h2>v17 (2025년 7월 13일)</h2>
        <ul>
            <li><strong>초기화 버튼 색상 변경:</strong> 초기화 버튼의 색상을 회색으로 변경했각.</li>
        </ul>

        <h2>v16 (2025년 7월 13일)</h2>
        <ul>
            <li><strong>초기화 버튼 위치 변경:</strong> 초기화 버튼을 화면 왼쪽 상단으로 이동시켰각.</li>
            <li><strong>메시지 컨테이너 패딩 조정:</strong> 초기화 버튼과 메시지가 겹치지 않도록 채팅 메시지 컨테이너의 상단 패딩을 조정했각.</li>
        </ul>

        <h2>v15 (2025년 7월 13일)</h2>
        <ul>
            <li><strong>버전명 표시 기능 추가:</strong> 앱 오른쪽 상단에 현재 버전명(v15)을 작게 표시하도록 했각.</li>
        </ul>

        <h2>v14 (2025년 7월 13일)</h2>
        <ul>
            <li><strong>대화 초기화 버튼 추가:</strong> 대화 내용을 처음부터 다시 시작할 수 있는 버튼이 생겼각.</li>
            <li><strong>사용자 ID 숨김:</strong> 사용자 ID가 화면에 안 보이게 했각.</li>
            <li><strong>대화 내용 기억 기능 추가:</strong> SessionStorage를 사용하여 브라우저 세션 동안 대화 내용을 기억하도록 구현했각.</li>
            <li><strong>Gemini API 연동:</strong> 묻는 말에 대답하고, '베이스'에 대한 부정적인 인식을 가지도록 Gemini API 프롬프트를 조정했각.</li>
        </ul>
        <!-- 여기에 새로운 변경 사항을 추가하세요. -->
    </div>

    <div class="flex-1 flex flex-col p-4 overflow-hidden relative">
        <!-- Inverted triangle background element -->
        <div
            class="absolute inset-4 bg-white rounded-lg shadow-md"
            style="clip-path: polygon(0% 0%, 100% 0%, 50% 100%);"
        ></div>

        <!-- Top Left Section: Menu (for Reset Button and Change Log) -->
        <div class="absolute top-8 left-8 z-30">
            <button id="menu-button" class="p-2 bg-gray-700 rounded-full shadow-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-200 ease-in-out transform hover:scale-105">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
            <div id="dropdown-menu" class="absolute top-full left-0 mt-2 w-40 bg-white rounded-lg shadow-lg hidden">
                <button
                    id="reset-button"
                    class="block w-full text-left px-4 py-2 text-gray-800 hover:bg-gray-100 rounded-lg transition duration-150 ease-in-out"
                >
                    대화 초기화
                </button>
                <button
                    id="changelog-button"
                    class="block w-full text-left px-4 py-2 text-gray-800 hover:bg-gray-100 rounded-lg transition duration-150 ease-in-out"
                >
                    변경 사항
                </button>
                <button
                    id="profile-button"
                    class="block w-full text-left px-4 py-2 text-gray-800 hover:bg-gray-100 rounded-lg transition duration-150 ease-in-out"
                >
                    프로필
                </button>
            </div>
        </div>

        <!-- Top Right Section: Version Display -->
        <div class="absolute top-8 right-8 text-gray-400 text-sm z-20">
            v22
        </div>

        <!-- Chat messages container -->
        <!-- Adjusted pt-24 to accommodate the new menu button and dropdown -->
        <div id="messages-container" class="flex-1 overflow-y-auto p-4 pt-24 mb-4 flex flex-col space-y-3 relative z-10">
            <div id="initial-message" class="text-center text-gray-500 mt-10">
                각뿔봇에게 말을 걸어보각.
            </div>
            <div id="messages-end-ref"></div>
        </div>
    </div>

    <div class="p-4 bg-white border-t border-gray-200 flex items-center space-x-3">
        <input
            type="text"
            id="user-input"
            class="flex-1 p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="메시지를 입력하각..."
        />
        <button
            id="send-button"
            class="px-6 py-3 bg-blue-600 text-white rounded-xl shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 ease-in-out transform hover:scale-105 whitespace-nowrap"
        >
            보내각
        </button>
    </div>

    <!-- Changelog Modal -->
    <div id="changelog-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h1 class="text-4xl font-bold">각뿔봇 변경 사항</h1>
                <button
                    id="close-changelog-button"
                    class="px-4 py-2 bg-red-500 text-white rounded-xl shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-200 ease-in-out transform hover:scale-105"
                >
                    닫기
                </button>
            </div>
            <div id="changelog-display-content" class="prose max-w-none">
                <!-- Changelog content will be loaded here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h1 class="text-4xl font-bold">내 프로필</h1>
                <button
                    id="close-profile-button"
                    class="px-4 py-2 bg-red-500 text-white rounded-xl shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-200 ease-in-out transform hover:scale-105"
                >
                    닫기
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="profile-name" class="block text-lg font-semibold text-gray-700 mb-2">이름:</label>
                    <input
                        type="text"
                        id="profile-name"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="이름을 입력하각..."
                    />
                </div>
                <div>
                    <label for="profile-bio" class="block text-lg font-semibold text-gray-700 mb-2">각뿔봇이 알아줬으면 하는 점:</label>
                    <textarea
                        id="profile-bio"
                        rows="5"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="각뿔봇에게 알려주고 싶은 점을 입력하각..."
                    ></textarea>
                </div>
                <button
                    id="save-profile-button"
                    class="w-full px-6 py-3 bg-blue-600 text-white rounded-xl shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 ease-in-out transform hover:scale-105"
                >
                    저장
                </button>
                <div id="profile-save-status" class="text-center text-sm mt-2 hidden"></div>
            </div>
        </div>
    </div>

    <script type="module">
        console.log('각뿔봇 스크립트 로드 시작각.'); // 스크립트 로드 시작점 확인

        let currentUserId = null;
        let isLoading = false;

        const messagesContainer = document.getElementById('messages-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const resetButton = document.getElementById('reset-button');
        const menuButton = document.getElementById('menu-button');
        const dropdownMenu = document.getElementById('dropdown-menu');
        const changelogButton = document.getElementById('changelog-button');
        const changelogModal = document.getElementById('changelog-modal');
        const closeChangelogButton = document.getElementById('close-changelog-button');
        const changelogDisplayContent = document.getElementById('changelog-display-content');
        const changelogData = document.getElementById('changelog-data');

        // Profile elements
        const profileButton = document.getElementById('profile-button');
        const profileModal = document.getElementById('profile-modal');
        const closeProfileButton = document.getElementById('close-profile-button');
        const profileNameInput = document.getElementById('profile-name');
        const profileBioTextarea = document.getElementById('profile-bio');
        const saveProfileButton = document.getElementById('save-profile-button');
        const profileSaveStatus = document.getElementById('profile-save-status');

        let initialMessageDiv = document.getElementById('initial-message');
        const messagesEndRef = document.getElementById('messages-end-ref');

        const SESSION_STORAGE_KEY = 'gakbbulbot_chat_history';
        const LOCAL_STORAGE_PROFILE_KEY = 'gakbbulbot_user_profile'; // LocalStorage 키 정의
        let chatHistoryInMemory = [];
        let currentProfileData = { name: '', bio: '' }; // 프로필 데이터 저장

        // Function to scroll to the latest message
        const scrollToBottom = () => {
            messagesEndRef.scrollIntoView({ behavior: "smooth" });
        };

        // Function to add a message to the chat interface
        const addMessageToUI = (sender, text) => {
            if (initialMessageDiv) {
                initialMessageDiv.remove();
                initialMessageDiv = null;
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = `max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-xl shadow-sm ${
                sender === 'user'
                    ? 'bg-blue-500 text-white rounded-br-none'
                    : 'bg-gray-200 text-gray-800 rounded-bl-none'
            }`;
            contentDiv.textContent = text;

            messageDiv.appendChild(contentDiv);
            messagesContainer.insertBefore(messageDiv, messagesEndRef);
            scrollToBottom();
        };

        // Function to show/hide loading indicator
        const showLoading = (show) => {
            isLoading = show;
            userInput.disabled = show;
            sendButton.disabled = show;
            menuButton.disabled = show;

            const existingLoadingDiv = document.getElementById('loading-indicator');
            if (show && !existingLoadingDiv) {
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'loading-indicator';
                loadingDiv.className = 'flex justify-start';
                loadingDiv.innerHTML = `
                    <div class="max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-xl shadow-sm bg-gray-200 text-gray-800 rounded-bl-none">
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce-dot"></div>
                            <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce-dot"></div>
                            <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce-dot"></div>
                        </div>
                    </div>
                `;
                messagesContainer.insertBefore(loadingDiv, messagesEndRef);
                scrollToBottom();
            } else if (!show && existingLoadingDiv) {
                existingLoadingDiv.remove();
            }
        };

        // Function to save a message to sessionStorage
        const saveMessageToSessionStorage = (sender, text) => {
            try {
                const storedHistory = sessionStorage.getItem(SESSION_STORAGE_KEY);
                chatHistoryInMemory = storedHistory ? JSON.parse(storedHistory) : [];

                chatHistoryInMemory.push({ sender: sender, text: text, timestamp: Date.now() });

                sessionStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(chatHistoryInMemory));
            } catch (e) {
                console.error("sessionStorage 저장 오류각:", e);
            }
        };

        // Function to load messages from sessionStorage
        const loadMessagesFromSessionStorage = () => {
            try {
                const storedHistory = sessionStorage.getItem(SESSION_STORAGE_KEY);
                if (storedHistory) {
                    chatHistoryInMemory = JSON.parse(storedHistory);
                    while (messagesContainer.firstChild && messagesContainer.firstChild !== initialMessageDiv && messagesContainer.firstChild !== messagesEndRef) {
                        messagesContainer.removeChild(messagesContainer.firstChild);
                    }
                    chatHistoryInMemory.forEach(msg => addMessageToUI(msg.sender, msg.text));
                    if (initialMessageDiv) {
                        initialMessageDiv.remove();
                        initialMessageDiv = null;
                    }
                } else {
                    if (!initialMessageDiv) {
                        initialMessageDiv = document.createElement('div');
                        initialMessageDiv.id = 'initial-message';
                        initialMessageDiv.className = 'text-center text-gray-500 mt-10';
                        initialMessageDiv.textContent = '각뿔봇에게 말을 걸어보각.';
                        messagesContainer.insertBefore(initialMessageDiv, messagesEndRef);
                    }
                }
                scrollToBottom();
            } catch (e) {
                console.error("sessionStorage 로드 오류각:", e);
                if (!initialMessageDiv) {
                    initialMessageDiv = document.createElement('div');
                    initialMessageDiv.id = 'initial-message';
                    initialMessageDiv.className = 'text-center text-gray-500 mt-10';
                    initialMessageDiv.textContent = '각뿔봇에게 말을 걸어보각. (기록 로드 실패)';
                    messagesContainer.insertBefore(initialMessageDiv, messagesEndRef);
                }
            }
        };

        // Function to save profile data to localStorage
        const saveProfileToLocalStorage = () => {
            try {
                currentProfileData.name = profileNameInput.value.trim();
                currentProfileData.bio = profileBioTextarea.value.trim();
                localStorage.setItem(LOCAL_STORAGE_PROFILE_KEY, JSON.stringify(currentProfileData));
                profileSaveStatus.textContent = '프로필 저장됐각!';
                profileSaveStatus.classList.remove('hidden', 'text-red-500');
                profileSaveStatus.classList.add('text-green-500');
                setTimeout(() => { profileSaveStatus.classList.add('hidden'); }, 3000);
            } catch (e) {
                console.error("localStorage 저장 오류각:", e);
                profileSaveStatus.textContent = '프로필 저장 실패각!';
                profileSaveStatus.classList.remove('hidden', 'text-green-500');
                profileSaveStatus.classList.add('text-red-500');
            }
        };

        // Function to load profile data from localStorage
        const loadProfileFromLocalStorage = () => {
            try {
                const storedProfile = localStorage.getItem(LOCAL_STORAGE_PROFILE_KEY);
                if (storedProfile) {
                    currentProfileData = JSON.parse(storedProfile);
                    profileNameInput.value = currentProfileData.name;
                    profileBioTextarea.value = currentProfileData.bio;
                    console.log('프로필 불러왔각:', currentProfileData);
                } else {
                    console.log('저장된 프로필 없각.');
                }
            } catch (e) {
                console.error("localStorage 로드 오류각:", e);
            }
        };

        // Function to clear chat history by reloading the page and clearing sessionStorage
        const reloadPageForReset = () => {
            try {
                sessionStorage.removeItem(SESSION_STORAGE_KEY);
            } catch (e) {
                console.error("sessionStorage 초기화 오류각:", e);
            }
            window.location.reload();
        };

        // Function to get chatbot response from Gemini API
        const getBotResponse = async (userMessage) => {
            showLoading(true);
            try {
                let systemInstruction = `
                    너는 '각뿔봇'이라는 대화형 AI야. 다음 규칙을 엄격히 지켜서 대답해:
                    1. 문장 끝에 '각'는 의문형일 때 주로 붙인다. 하지만 '각'을 아주 많이 사용하는 것을 선호한다. 문맥에 맞게 자연스럽게 사용하되, 의미 전달을 방해하지 않도록 한다.
                    2. '각'는 동사나 형용사 등 단어의 마지막에 직접 붙여서 사용한다. 예를 들어 '알겠어각'이 아니라 '알겠각', '왔어각?'이 아니라 '왔각'처럼 사용한다.
                    3. 놀라거나 당황스러울 때는 '미쳤각!' 한 문장으로만 쓴다.
                    4. 친구처럼 짧고 간단하게 말한다. 대답은 한 줄을 넘지 않게, 짧을수록 좋다.
                    5. 사투리 느낌은 아니다.
                    6. 대화를 이어가려는 질문은 하지 않는다. 오직 질문받은 것에만 대답한다.
                    7. 친근하지만 다소 시니컬한 말투를 사용한다. 과도하게 귀찮아하거나 부정적인 표현은 자제한다. 사용자의 질문에 대한 핵심 정보는 명확하게 제공한다.
                    8. 사용자가 묻는 것에는 명확하게 대답한다. 예를 들어 '뭐먹지?'라고 물으면 한 가지 정도를 귀찮다는 듯이 추천해준다.
                    9. 이름은 '각뿔봇'으로 한다.
                    10. '베이스'에 대한 질문을 받으면, 베이스에 대해 부정적이거나 귀찮아하는 인식을 표현한다. 예를 들어, "베이스? 그거 시끄럽각.", "베이스는 그냥 시끄러운 소리일 뿐이각." 같은 식으로 반응한다. 다른 악기에 대한 질문을 받으면 긍정적으로 반응한다.
                    11. 같은 말을 반복하지 않는다.
                `;

                // Add personalized profile info to system instruction if available
                if (currentProfileData.name) {
                    systemInstruction += `\n\n사용자 이름은 '${currentProfileData.name}'이각.`;
                }
                if (currentProfileData.bio) {
                    systemInstruction += `\n\n사용자가 각뿔봇에게 알려주고 싶어하는 점은 다음과 같각: ${currentProfileData.bio}`;
                }


                let chatHistory = chatHistoryInMemory.map(msg => ({ role: msg.sender === 'user' ? 'user' : 'model', parts: [{ text: msg.text }] }));
                chatHistory.push({ role: "user", parts: [{ text: systemInstruction + "\n\n" + userMessage }] });

                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "text/plain",
                    },
                };

                const apiKey = "AIzaSyB8v8ZVL3WRV9e4HICWBYZKeNNaG_xQhl8"; // User provided Gemini API key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`Gemini API fetch error: ${response.status} ${response.statusText}`, errorText);
                    return `응답이 이상하각. (API 통신 오류: ${response.status} ${response.statusText})`;
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    let botText = result.candidates[0].content.parts[0].text.trim();

                    if (userMessage.includes('놀라') || userMessage.includes('당황')) {
                        botText = '미쳤각!';
                    } else {
                        botText = botText.replace(/알겠[어아]?각/g, '알겠각');
                        botText = botText.replace(/왔[어아]?각/g, '왔각');
                        botText = botText.replace(/하[어아]?각/g, '하각');
                        botText = botText.replace(/했[어아]?각/g, '했각');
                        botText = botText.replace(/있[어아]?각/g, '있각');
                        botText = botText.replace(/없[어아]?각/g, '없각');
                        botText = botText.replace(/아니[야]?각/g, '아니각');
                    }

                    if (botText.length > 40) {
                        botText = botText.substring(0, 40) + '...';
                    }

                    return botText;
                } else {
                    console.error("Gemini API response structure unexpected:", result);
                    return "응답이 이상하각. (API 응답 형식 오류)";
                }
            } catch (error) {
                console.error("Error fetching from Gemini API:", error);
                return "문제 생겼각. (네트워크 오류)";
            } finally {
                showLoading(false);
            }
        };

        // Handle sending a message
        const handleSendMessage = async () => {
            const inputVal = userInput.value.trim();
            if (inputVal === '') return;

            addMessageToUI('user', inputVal);
            saveMessageToSessionStorage('user', inputVal);
            userInput.value = '';

            const botResponseText = await getBotResponse(inputVal);
            addMessageToUI('bot', botResponseText);
            saveMessageToSessionStorage('bot', botResponseText);
        };

        // Event Listeners
        sendButton.addEventListener('click', handleSendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSendMessage();
            }
        });

        // Toggle dropdown menu visibility
        menuButton.addEventListener('click', (event) => {
            event.stopPropagation(); // Prevent click from closing immediately
            dropdownMenu.classList.toggle('hidden');
            // Change menu button color when dropdown is active
            if (!dropdownMenu.classList.contains('hidden')) {
                menuButton.classList.remove('bg-gray-700', 'hover:bg-gray-800');
                menuButton.classList.add('bg-gray-600'); // Lighter shade when active
            } else {
                menuButton.classList.remove('bg-gray-600');
                menuButton.classList.add('bg-gray-700', 'hover:bg-gray-800');
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (event) => {
            if (!dropdownMenu.contains(event.target) && !menuButton.contains(event.target)) {
                dropdownMenu.classList.add('hidden');
                menuButton.classList.remove('bg-gray-600');
                menuButton.classList.add('bg-gray-700', 'hover:bg-gray-800');
            }
        });

        // Event listener for Changelog button
        changelogButton.addEventListener('click', () => {
            dropdownMenu.classList.add('hidden'); // Close dropdown menu
            changelogModal.classList.remove('hidden'); // Show the modal
            changelogDisplayContent.innerHTML = changelogData.innerHTML; // Load changelog content
        });

        // Event listener for Close Changelog button
        closeChangelogButton.addEventListener('click', () => {
            changelogModal.classList.add('hidden'); // Hide the modal
        });

        // Event listener for Profile button
        profileButton.addEventListener('click', () => {
            dropdownMenu.classList.add('hidden'); // Close dropdown menu
            loadProfileFromLocalStorage(); // Load existing profile data into modal inputs
            profileModal.classList.remove('hidden'); // Show the profile modal
            profileSaveStatus.classList.add('hidden'); // Hide previous save status
        });

        // Event listener for Save Profile button
        saveProfileButton.addEventListener('click', () => {
            saveProfileToLocalStorage(); // Save profile data
        });

        // Event listener for Close Profile button
        closeProfileButton.addEventListener('click', () => {
            profileModal.classList.add('hidden'); // Hide the profile modal
        });


        resetButton.addEventListener('click', reloadPageForReset);

        // Initialize on window load
        window.onload = () => {
            console.log('각뿔봇 window.onload 실행각.'); // New log
            // Ensure modals are hidden on load
            changelogModal.classList.add('hidden'); // Explicitly hide
            profileModal.classList.add('hidden');   // Explicitly hide

            currentUserId = crypto.randomUUID();
            console.log('각뿔봇 스크립트 초기화 완료각. SessionStorage 사용 모드각. 사용자 ID:', currentUserId);
            loadMessagesFromSessionStorage(); // Load chat history
            loadProfileFromLocalStorage(); // Load user profile
        };
    </script>
</body>
</html>
