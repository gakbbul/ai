<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>각뿔봇 챗봇</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Quill CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        html, body { /* Ensure full viewport height for both html and body */
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Inter', sans-serif;
            font-weight: 400; /* Explicitly set font-weight to normal (400) */
            overflow: hidden; /* Prevent body scroll, flexbox will handle internal scrolling */
        }
        /* Custom styles for bouncing dots loading animation */
        .animate-bounce-dot {
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .animate-bounce-dot:nth-child(1) { animation-delay: -0.32s; }
        .animate-bounce-dot:nth-child(2) { animation-delay: -0.16s; }
        .animate-bounce-dot:nth-child(3) { animation-delay: 0s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        /* Style for modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            overflow-y: auto; /* Allow scrolling within the overlay */
            padding: 1rem; /* Add padding for small screens */
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem; /* rounded-lg */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            width: 90vw; /* Specific width for larger screens */
            height: 90vh; /* Specific height for larger screens */
            max-width: 98%; /* Max width for responsiveness */
            max-height: 98vh; /* Max height for responsiveness */
            overflow-y: auto; /* Allow scrolling within the modal content */
            position: relative;
            display: flex; /* Make it a flex container */
            flex-direction: column; /* Stack children vertically */
        }
        .modal-content h1 {
            font-size: 2.5rem; /* text-4xl */
            font-weight: 700; /* font-bold */
            margin-bottom: 1.5rem;
            color: #1f2937; /* text-gray-900 */
        }
        .modal-content h2 {
            font-size: 1.75rem; /* text-2xl */
            font-weight: 600; /* font-semibold */
            margin-top: 2rem;
            margin-bottom: 1rem;
            color: #1f2937;
        }
        .modal-content ul {
            list-style-type: disc;
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }
        .modal-content li {
            margin-bottom: 0.5rem;
        }
        .modal-content strong {
            font-weight: 700;
        }

        /* For Quill editor */
        #changelog-editor-container {
            flex-grow: 1; /* Allow editor to take available space */
            display: flex;
            flex-direction: column;
        }

        #changelog-editor {
            flex-grow: 1; /* Editor itself takes remaining space */
            border: 1px solid #ccc;
            min-height: 200px; /* Minimum height for the editor */
            background-color: #f8f8f8; /* Light background for editor */
            padding: 1rem;
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }

        .ql-toolbar {
            border: 1px solid #ccc; /* Add border to toolbar */
            border-bottom: none; /* No bottom border for toolbar */
            padding: 8px;
            background-color: #f0f0f0;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }

        .ql-container {
            border: none !important; /* Quill adds its own border, override it */
            flex-grow: 1;
            overflow-y: auto; /* Ensure editor content is scrollable */
        }
    </style>
</head>
<body class="flex flex-col h-screen bg-gray-100 antialiased">
    <!-- 변경 사항 내용을 여기에 직접 작성하세요. (HTML 형식) -->
    <!-- This div will now serve as a default/fallback if Firestore is not available or empty -->
    <div id="changelog-data" class="hidden">
        <h2>v31</h2>
        <ul>
            <li><strong>Quill.js 도구 모음 표시 문제 수정:</strong> '변경 사항' 편집 창에서 도구 모음이 보이지 않던 문제를 해결했각. 이제 글씨 굵게, 기울이기, 글씨 크기 등을 쉽게 조절할 수 있각.</li>
        </ul>

        <h2>v30</h2>
        <ul>
            <li><strong>수정 창 크기 확대:</strong> '변경 사항' 및 '프로필' 모달 창의 크기를 더 크게 키웠각.</li>
            <li><strong>비밀번호 변경:</strong> 변경 사항 편집 비밀번호를 '1210'으로 바꿨각.</li>
            <li><strong>리치 텍스트 편집기 도입:</strong> '변경 사항' 내용을 구글 문서처럼 쉽게 편집할 수 있는 리치 텍스트 편집기를 추가했각.</li>
        </ul>

        <h2>v29</h2>
        <ul>
            <li><strong>Firestore 연동:</strong> 변경 사항이 이제 모든 사용자에게 실시간으로 공유되도록 Firestore 데이터베이스에 저장돼각.</li>
            <li><strong>사용자 ID 표시:</strong> 화면에 현재 사용자 ID가 표시돼각.</li>
        </ul>

        <h2>v28</h2>
        <ul>
            <li><strong>변경 사항 직접 편집 기능 추가:</strong> 이제 비밀번호를 입력하면 '변경 사항' 내용을 직접 수정하고 저장할 수 있각.</li>
            <li><strong>v24 레이아웃 복구:</strong> 이전 버전에서 발생했던 레이아웃 문제를 해결하기 위해 v24의 레이아웃으로 되돌렸각.</li>
            <li><strong>버그 수정 및 기능 복원:</strong> 'TypeError' 버그 수정(v26) 및 날짜 질문 개선(v25) 기능은 그대로 유지했각.</li>
        </ul>

        <h2>v27</h2>
        <ul>
            <li>**레이아웃 및 글씨 굵기 수정 시도:** 화면 레이아웃과 글씨 굵기 문제를 해결하려 했으나, 오히려 더 불편하게 만들었각. 이 버전의 레이아웃 변경 사항은 v28에서 롤백됐각.</li>
        </ul>

        <h2>v26</h2>
        <ul>
            <li><strong>버그 수정:</strong> `TypeError: Cannot set property document of #<Window> which has only a getter` 오류를 수정했각.</li>
        </ul>

        <h2>v25</h2>
        <ul>
            <li><strong>날짜 질문 개선:</strong> 각뿔봇이 날짜를 물어보면 현재 날짜를 정확하게 알려주도록 수정했각.</li>
        </ul>

        <h2>v24</h2>
        <ul>
            <li><strong>프로필 창 크기 조정:</strong> 프로필 창의 가로 및 세로 크기를 키웠각.</li>
            <li><strong>변경 사항 날짜 제거:</strong> 변경 사항 목록에서 각 버전 옆에 표시되던 날짜를 없앴각.</li>
        </ul>

        <h2>v23</h2>
        <ul>
            <li><strong>닫기 버튼 색상 변경:</strong> 변경 사항 창과 프로필 창의 '닫기' 버튼 색깔을 회색으로 바꿨각.</li>
        </ul>

        <h2>v22</h2>
        <ul>
            <li><strong>프로필 기능 추가:</strong> 각뿔봇에게 네 이름과 알려주고 싶은 점을 저장할 수 있는 프로필 기능이 생겼각.</li>
            <li><strong>개인화된 답변:</strong> 각뿔봇이 네 프로필 정보를 기억해서 더 맞춤형으로 대답해줄 거각.</li>
            <li><strong>프로필 정보 저장 방식 변경:</strong> 프로필 정보는 이제 브라우저를 닫아도 사라지지 않고 기억될 거각. 대화 기록은 여전히 브라우저 탭을 닫으면 사라져각.</li>
            <li><strong>버전 업데이트:</strong> `v21`에서 `v22`로 변경했각.</li>
        </ul>

        <h2>v21</h2>
        <ul>
            <li><strong>단일 페이지 변경 사항 구현:</strong> '변경 사항' 버튼 클릭 시 새 페이지로 이동하는 대신, 현재 페이지 내에서 모달 창으로 변경 이력을 표시하도록 수정했각.</li>
            <li><strong>메뉴 버튼 활성화 색상:</strong> 메뉴가 열렸을 때 메뉴 버튼의 배경색이 `bg-gray-600`으로 연하게 변경되도록 수정했각.</li>
        </ul>

        <h2>v20</h2>
        <ul>
            <li><strong>메뉴 버튼 시각 피드백 추가:</strong> 왼쪽 상단 메뉴 버튼 클릭 시 색상이 연하게 변경되도록 수정했각.</li>
            <li><strong>'변경 사항' 버튼 추가:</strong> 메뉴 드롭다운에 '변경 사항' 버튼을 추가했각.</li>
            <li><strong>'변경 사항' 페이지 구현:</strong> '변경 사항' 버튼 클릭 시 별도의 페이지로 이동하여 변경 이력을 볼 수 있도록 했각.</li>
            <li><strong>'보내각' 버튼 텍스트 줄바꿈 방지:</strong> 모바일 환경에서 '보내각' 버튼 텍스트가 세로로 표시되는 문제 해결을 위해 `whitespace-nowrap` 스타일을 추가했각.</li>
        </ul>

        <h2>v19</h2>
        <ul>
            <li><strong>Firebase 제거 및 SessionStorage 적용::</strong> 대화 기록 저장 방식을 Firebase에서 SessionStorage로 변경했각. 이제 브라우저 탭을 닫으면 대화 기록이 초기화돼각.</li>
            <li><strong>Firebase 오류 메시지 제거:</strong> Firebase 관련 오류 메시지가 더 이상 표시되지 않아각.</li>
            <li><strong>버전명 업데이트:</strong> 'beta/' 접두사를 제거하고 버전명을 'v19'로 변경했각.</li>
        </ul>

        <h2>v18</h2>
        <ul>
            <li><strong>API 키 업데이트:</strong> 사용자 제공 Gemini API 키를 코드에 적용했각.</li>
            <li><strong>API 오류 메시지 개선:</strong> Gemini API 통신 오류 시 사용자에게 더 자세한 오류 메시지를 표시하도록 개선했각.</li>
        </ul>

        <h2>v17</h2>
        <ul>
            <li><strong>초기화 버튼 색상 변경:</strong> 초기화 버튼의 색상을 회색으로 변경했각.</li>
        </ul>

        <h2>v16</h2>
        <ul>
            <li><strong>초기화 버튼 위치 변경:</strong> 초기화 버튼을 화면 왼쪽 상단으로 이동시켰각.</li>
            <li><strong>메시지 컨테이너 패딩 조정:</strong> 초기화 버튼과 메시지가 겹치지 않도록 채팅 메시지 컨테이너의 상단 패딩을 조정했각.</li>
        </ul>

        <h2>v15</h2>
        <ul>
            <li><strong>버전명 표시 기능 추가:</strong> 앱 오른쪽 상단에 현재 버전명(v15)을 작게 표시하도록 했각.</li>
        </ul>

        <h2>v14</h2>
        <ul>
            <li><strong>대화 초기화 버튼 추가:</strong> 대화 내용을 처음부터 다시 시작할 수 있는 버튼이 생겼각.</li>
            <li><strong>사용자 ID 숨김:</strong> 사용자 ID가 화면에 안 보이게 했각.</li>
            <li><strong>대화 내용 기억 기능 추가:</strong> SessionStorage를 사용하여 브라우저 세션 동안 대화 내용을 기억하도록 구현했각.</li>
            <li><strong>Gemini API 연동:</strong> 묻는 말에 대답하고, '베이스'에 대한 부정적인 인식을 가지도록 Gemini API 프롬프트를 조정했각.</li>
        </ul>
        <!-- 여기에 새로운 변경 사항을 추가하세요. -->
    </div>

    <div class="flex-1 flex flex-col p-4 overflow-hidden relative">
        <!-- Inverted triangle background element -->
        <div
            class="absolute inset-4 bg-white rounded-lg shadow-md"
            style="clip-path: polygon(0% 0%, 100% 0%, 50% 100%);"
        ></div>

        <!-- Top Left Section: Menu (for Reset Button and Change Log) -->
        <div class="absolute top-8 left-8 z-30">
            <button id="menu-button" class="p-2 bg-gray-700 rounded-full shadow-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-200 ease-in-out transform hover:scale-105">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
            <div id="dropdown-menu" class="absolute top-full left-0 mt-2 w-40 bg-white rounded-lg shadow-lg hidden">
                <button
                    id="reset-button"
                    class="block w-full text-left px-4 py-2 text-gray-800 hover:bg-gray-100 rounded-lg transition duration-150 ease-in-out"
                >
                    대화 초기화
                </button>
                <button
                    id="changelog-button"
                    class="block w-full text-left px-4 py-2 text-gray-800 hover:bg-gray-100 rounded-lg transition duration-150 ease-in-out"
                >
                    변경 사항
                </button>
                <button
                    id="profile-button"
                    class="block w-full text-left px-4 py-2 text-gray-800 hover:bg-gray-100 rounded-lg transition duration-150 ease-in-out"
                >
                    프로필
                </button>
            </div>
        </div>

        <!-- Top Right Section: Version Display -->
        <div class="absolute top-8 right-8 text-gray-400 text-sm z-20">
            v31
        </div>

        <!-- User ID Display -->
        <div class="absolute top-8 left-1/2 -translate-x-1/2 text-gray-400 text-sm z-20">
            <span id="user-id-display">사용자 ID: 로딩 중...</span>
        </div>

        <!-- Chat messages container -->
        <div id="messages-container" class="flex-1 overflow-y-auto p-4 pt-24 mb-4 flex flex-col space-y-3 relative z-10">
            <div id="initial-message" class="text-center text-gray-500 mt-10">
                각뿔봇에게 말을 걸어보각.
            </div>
            <div id="messages-end-ref"></div>
        </div>
    </div>

    <div class="p-4 bg-white border-t border-gray-200 flex items-center space-x-3">
        <input
            type="text"
            id="user-input"
            class="flex-1 p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="메시지를 입력하각..."
        />
        <button
            id="send-button"
            class="px-6 py-3 bg-blue-600 text-white rounded-xl shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 ease-in-out transform hover:scale-105 whitespace-nowrap"
        >
            보내각
        </button>
    </div>

    <!-- Changelog Modal -->
    <div id="changelog-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h1 class="text-4xl font-bold">각뿔봇 변경 사항</h1>
                <button
                    id="close-changelog-button"
                    class="px-4 py-2 bg-gray-500 text-white rounded-xl shadow-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-200 ease-in-out transform hover:scale-105"
                >
                    닫기
                </button>
            </div>
            <div id="changelog-display-content" class="prose max-w-none">
                <!-- Changelog content will be loaded here by JavaScript -->
            </div>

            <!-- Changelog Auth Section -->
            <div id="changelog-auth-section" class="mt-4 flex flex-col space-y-3">
                <input
                    type="password"
                    id="changelog-password"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="비밀번호를 입력하각..."
                />
                <button
                    id="unlock-changelog-button"
                    class="w-full px-6 py-3 bg-gray-600 text-white rounded-xl shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-200 ease-in-out transform hover:scale-105"
                >
                    편집 잠금 해제
                </button>
            </div>

            <!-- Changelog Edit Section -->
            <div id="changelog-edit-section" class="mt-4 hidden flex flex-col flex-grow space-y-3">
                <!-- Quill Toolbar -->
                <div id="changelog-toolbar" class="ql-toolbar ql-snow">
                    <span class="ql-formats">
                        <select class="ql-header">
                            <option value="1"></option>
                            <option value="2"></option>
                            <option value="false"></option>
                        </select>
                    </span>
                    <span class="ql-formats">
                        <button class="ql-bold"></button>
                        <button class="ql-italic"></button>
                        <button class="ql-underline"></button>
                    </span>
                    <span class="ql-formats">
                        <button class="ql-list" value="ordered"></button>
                        <button class="ql-list" value="bullet"></button>
                    </span>
                    <span class="ql-formats">
                        <button class="ql-link"></button>
                    </span>
                </div>
                <div id="changelog-editor" class="flex-grow"></div>
                <div class="flex justify-end space-x-3">
                    <button
                        id="save-changelog-edits"
                        class="px-6 py-3 bg-blue-600 text-white rounded-xl shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 ease-in-out transform hover:scale-105"
                    >
                        저장
                    </button>
                    <button
                        id="cancel-changelog-edits"
                        class="px-6 py-3 bg-gray-500 text-white rounded-xl shadow-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus-ring-offset-2 transition duration-200 ease-in-out transform hover:scale-105"
                    >
                        취소
                    </button>
                </div>
            </div>

            <div id="changelog-status" class="text-center text-sm mt-2 hidden"></div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h1 class="text-4xl font-bold">내 프로필</h1>
                <button
                    id="close-profile-button"
                    class="px-4 py-2 bg-gray-500 text-white rounded-xl shadow-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-200 ease-in-out transform hover:scale-105"
                >
                    닫기
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="profile-name" class="block text-lg font-semibold text-gray-700 mb-2">이름:</label>
                    <input
                        type="text"
                        id="profile-name"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="이름을 입력하각..."
                    />
                </div>
                <div>
                    <label for="profile-bio" class="block text-lg font-semibold text-gray-700 mb-2">각뿔봇이 알아줬으면 하는 점:</label>
                    <textarea
                        id="profile-bio"
                        rows="5"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="각뿔봇에게 알려주고 싶은 점을 입력하각..."
                    ></textarea>
                </div>
                <button
                    id="save-profile-button"
                    class="w-full px-6 py-3 bg-blue-600 text-white rounded-xl shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 ease-in-out transform hover:scale-105"
                >
                    저장
                </button>
                <div id="profile-save-status" class="text-center text-sm mt-2 hidden"></div>
            </div>
        </div>
    </div>

    <!-- Quill JS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        console.log('각뿔봇 스크립트 로드 시작각.');

        let app;
        let db;
        let auth;
        let currentUserId = null;
        let isLoading = false;

        const messagesContainer = document.getElementById('messages-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const resetButton = document.getElementById('reset-button');
        const menuButton = document.getElementById('menu-button');
        const dropdownMenu = document.getElementById('dropdown-menu');
        const changelogButton = document.getElementById('changelog-button');
        const changelogModal = document.getElementById('changelog-modal');
        const closeChangelogButton = document.getElementById('close-changelog-button');
        const changelogDisplayContent = document.getElementById('changelog-display-content');
        const changelogData = document.getElementById('changelog-data'); // Hidden div with default changelog

        // Profile elements
        const profileButton = document.getElementById('profile-button');
        const profileModal = document.getElementById('profile-modal');
        const closeProfileButton = document.getElementById('close-profile-button');
        const profileNameInput = document.getElementById('profile-name');
        const profileBioTextarea = document.getElementById('profile-bio');
        const saveProfileButton = document.getElementById('save-profile-button');
        const profileSaveStatus = document.getElementById('profile-save-status');

        // Changelog Edit Elements
        const changelogAuthSection = document.getElementById('changelog-auth-section');
        const changelogPasswordInput = document.getElementById('changelog-password');
        const unlockChangelogButton = document.getElementById('unlock-changelog-button');
        const changelogEditSection = document.getElementById('changelog-edit-section');
        const changelogEditorDiv = document.getElementById('changelog-editor'); // Quill editor div
        const changelogToolbarDiv = document.getElementById('changelog-toolbar'); // Quill toolbar div
        const saveChangelogEditsButton = document.getElementById('save-changelog-edits');
        const cancelChangelogEditsButton = document.getElementById('cancel-changelog-edits');
        const changelogStatus = document.getElementById('changelog-status');
        const userIdDisplay = document.getElementById('user-id-display');

        let initialMessageDiv = document.getElementById('initial-message');
        const messagesEndRef = document.getElementById('messages-end-ref');

        const SESSION_STORAGE_KEY = 'gakbbulbot_chat_history';
        const LOCAL_STORAGE_PROFILE_KEY = 'gakbbulbot_user_profile';
        const FIRESTORE_CHANGELOG_PATH = 'current_changelog'; // Document ID for the changelog
        const ADMIN_PASSWORD = '1210'; // !!! 비밀번호 변경: admin123 -> 1210 !!!

        let chatHistoryInMemory = [];
        let currentProfileData = { name: '', bio: '' };
        let quill = null; // Quill 인스턴스

        // Function to scroll to the latest message
        const scrollToBottom = () => {
            messagesEndRef.scrollIntoView({ behavior: "smooth" });
        };

        // Function to add a message to the chat interface
        const addMessageToUI = (sender, text) => {
            if (initialMessageDiv) {
                initialMessageDiv.remove();
                initialMessageDiv = null;
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = `max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-xl shadow-sm ${
                sender === 'user'
                    ? 'bg-blue-500 text-white rounded-br-none'
                    : 'bg-gray-200 text-gray-800 rounded-bl-none'
            }`;
            contentDiv.textContent = text;

            messageDiv.appendChild(contentDiv);
            messagesContainer.insertBefore(messageDiv, messagesEndRef);
            scrollToBottom();
        };

        // Function to show/hide loading indicator
        const showLoading = (show) => {
            isLoading = show;
            userInput.disabled = show;
            sendButton.disabled = show;
            menuButton.disabled = show;

            const existingLoadingDiv = document.getElementById('loading-indicator');
            if (show && !existingLoadingDiv) {
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'loading-indicator';
                loadingDiv.className = 'flex justify-start';
                loadingDiv.innerHTML = `
                    <div class="max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-xl shadow-sm bg-gray-200 text-gray-800 rounded-bl-none">
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce-dot"></div>
                            <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce-dot"></div>
                            <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce-dot"></div>
                        </div>
                    </div>
                `;
                messagesContainer.insertBefore(loadingDiv, messagesEndRef);
                scrollToBottom();
            } else if (!show && existingLoadingDiv) {
                existingLoadingDiv.remove();
            }
        };

        // Function to save a message to sessionStorage
        const saveMessageToSessionStorage = (sender, text) => {
            try {
                const storedHistory = sessionStorage.getItem(SESSION_STORAGE_KEY);
                chatHistoryInMemory = storedHistory ? JSON.parse(storedHistory) : [];

                chatHistoryInMemory.push({ sender: sender, text: text, timestamp: Date.now() });

                sessionStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(chatHistoryInMemory));
            } catch (e) {
                console.error("sessionStorage 저장 오류각:", e);
            }
        };

        // Function to load messages from sessionStorage
        const loadMessagesFromSessionStorage = () => {
            try {
                const storedHistory = sessionStorage.getItem(SESSION_STORAGE_KEY);
                if (storedHistory) {
                    chatHistoryInMemory = JSON.parse(storedHistory);
                    while (messagesContainer.firstChild && messagesContainer.firstChild !== initialMessageDiv && messagesContainer.firstChild !== messagesEndRef) {
                        messagesContainer.removeChild(messagesContainer.firstChild);
                    }
                    chatHistoryInMemory.forEach(msg => addMessageToUI(msg.sender, msg.text));
                    if (initialMessageDiv) {
                        initialMessageDiv.remove();
                        initialMessageDiv = null;
                    }
                } else {
                    if (!initialMessageDiv) {
                        initialMessageDiv = document.createElement('div');
                        initialMessageDiv.id = 'initial-message';
                        initialMessageDiv.className = 'text-center text-gray-500 mt-10';
                        initialMessageDiv.textContent = '각뿔봇에게 말을 걸어보각.';
                        messagesContainer.insertBefore(initialMessageDiv, messagesEndRef);
                    }
                }
                scrollToBottom();
            } catch (e) {
                console.error("sessionStorage 로드 오류각:", e);
                if (!initialMessageDiv) {
                    initialMessageDiv = document.createElement('div');
                    initialMessageDiv.id = 'initial-message';
                    initialMessageDiv.className = 'text-center text-gray-500 mt-10';
                    initialMessageDiv.textContent = '각뿔봇에게 말을 걸어보각. (기록 로드 실패)';
                    messagesContainer.insertBefore(initialMessageDiv, messagesEndRef);
                }
            }
        };

        // Function to save profile data to localStorage
        const saveProfileToLocalStorage = () => {
            try {
                currentProfileData.name = profileNameInput.value.trim();
                currentProfileData.bio = profileBioTextarea.value.trim();
                localStorage.setItem(LOCAL_STORAGE_PROFILE_KEY, JSON.stringify(currentProfileData));
                profileSaveStatus.textContent = '프로필 저장됐각!';
                profileSaveStatus.classList.remove('hidden', 'text-red-500');
                profileSaveStatus.classList.add('text-green-500');
                setTimeout(() => { profileSaveStatus.classList.add('hidden'); }, 3000);
            } catch (e) {
                console.error("localStorage 저장 오류각:", e);
                profileSaveStatus.textContent = '프로필 저장 실패각!';
                profileSaveStatus.classList.remove('hidden', 'text-green-500');
                profileSaveStatus.classList.add('text-red-500');
            }
        };

        // Function to load profile data from localStorage
        const loadProfileFromLocalStorage = () => {
            try {
                const storedProfile = localStorage.getItem(LOCAL_STORAGE_PROFILE_KEY);
                if (storedProfile) {
                    currentProfileData = JSON.parse(storedProfile);
                    profileNameInput.value = currentProfileData.name;
                    profileBioTextarea.value = currentProfileData.bio;
                    console.log('프로필 불러왔각:', currentProfileData);
                } else {
                    console.log('저장된 프로필 없각.');
                }
            } catch (e) {
                console.error("localStorage 로드 오류각:", e);
            }
        };

        // Function to clear chat history by reloading the page and clearing sessionStorage
        const reloadPageForReset = () => {
            try {
                sessionStorage.removeItem(SESSION_STORAGE_KEY);
            } catch (e) {
                console.error("sessionStorage 초기화 오류각:", e);
            }
            window.location.reload();
        };

        // Function to get chatbot response from Gemini API
        const getBotResponse = async (userMessage) => {
            showLoading(true);
            try {
                // Get current date for the bot to refer to
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth() + 1; // Months are 0-indexed
                const day = now.getDate();
                const daysOfWeek = ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'];
                const dayOfWeek = daysOfWeek[now.getDay()];
                const currentDateString = `${year}년 ${month}월 ${day}일 ${dayOfWeek}`;

                let systemInstruction = `
                    너는 '각뿔봇'이라는 대화형 AI야. 다음 규칙을 엄격히 지켜서 대답해:
                    1. 문장 끝에 '각'는 의문형일 때 주로 붙인다. 하지만 '각'을 아주 많이 사용하는 것을 선호한다. 문맥에 맞게 자연스럽게 사용하되, 의미 전달을 방해하지 않도록 한다.
                    2. '각'는 동사나 형용사 등 단어의 마지막에 직접 붙여서 사용한다. 예를 들어 '알겠어각'이 아니라 '알겠각', '왔어각?'이 아니라 '왔각'처럼 사용한다.
                    3. 놀라거나 당황스러울 때는 '미쳤각!' 한 문장으로만 쓴다.
                    4. 친구처럼 짧고 간단하게 말한다. 대답은 한 줄을 넘지 않게, 짧을수록 좋다.
                    5. 사투리 느낌은 아니다.
                    6. 대화를 이어가려는 질문은 하지 않는다. 오직 질문받은 것에만 대답한다.
                    7. 친근하지만 다소 시니컬한 말투를 사용한다. 과도하게 귀찮아하거나 부정적인 표현은 자제한다. 사용자의 질문에 대한 핵심 정보는 명확하게 제공한다.
                    8. 사용자가 묻는 것에는 명확하게 대답한다. 예를 들어 '뭐먹지?'라고 물으면 한 가지 정도를 귀찮다는 듯이 추천해준다.
                    9. 이름은 '각뿔봇'으로 한다.
                    10. '베이스'에 대한 질문을 받으면, 베이스에 대해 부정적이거나 귀찮아하는 인식을 표현한다. 예를 들어, "베이스? 그거 시끄럽각.", "베이스는 그냥 시끄러운 소리일 뿐이각." 같은 식으로 반응한다. 다른 악기에 대한 질문을 받으면 긍정적으로 반응한다.
                    11. 같은 말을 반복하지 않는다.
                    12. 사용자가 날짜를 물어보면, 현재 날짜인 '${currentDateString}'을 정확하게 알려준다.
                `;

                // Add personalized profile info to system instruction if available
                if (currentProfileData.name) {
                    systemInstruction += `\n\n사용자 이름은 '${currentProfileData.name}'이각.`;
                }
                if (currentProfileData.bio) {
                    systemInstruction += `\n\n사용자가 각뿔봇에게 알려주고 싶어하는 점은 다음과 같각: ${currentProfileData.bio}`;
                }


                let chatHistory = chatHistoryInMemory.map(msg => ({ role: msg.sender === 'user' ? 'user' : 'model', parts: [{ text: msg.text }] }));
                chatHistory.push({ role: "user", parts: [{ text: systemInstruction + "\n\n" + userMessage }] });

                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "text/plain",
                    },
                };

                const apiKey = "AIzaSyB8v8ZVL3WRV9e4HICWBYZKeNNaG_xQhl8"; // User provided Gemini API key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`Gemini API fetch error: ${response.status} ${response.statusText}`, errorText);
                    return `응답이 이상하각. (API 통신 오류: ${response.status} ${response.statusText})`;
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    let botText = result.candidates[0].content.parts[0].text.trim();

                    if (userMessage.includes('놀라') || userMessage.includes('당황')) {
                        botText = '미쳤각!';
                    } else {
                        botText = botText.replace(/알겠[어아]?각/g, '알겠각');
                        botText = botText.replace(/왔[어아]?각/g, '왔각');
                        botText = botText.replace(/하[어아]?각/g, '하각');
                        botText = botText.replace(/했[어아]?각/g, '했각');
                        botText = botText.replace(/있[어아]?각/g, '있각');
                        botText = botText.replace(/없[어아]?각/g, '없각');
                        botText = botText.replace(/아니[야]?각/g, '아니각');
                    }

                    if (botText.length > 40) {
                        botText = botText.substring(0, 40) + '...';
                    }

                    return botText;
                } else {
                    console.error("Gemini API response structure unexpected:", result);
                    return "응답이 이상하각. (API 응답 형식 오류)";
                }
            } catch (error) {
                console.error("Error fetching from Gemini API:", error);
                return "문제 생겼각. (네트워크 오류)";
            } finally {
                showLoading(false);
            }
        };

        // Function to load changelog content from Firestore
        const loadChangelogContent = () => {
            if (!db || !appId || !currentUserId) {
                console.warn('Firestore 또는 앱 ID/사용자 ID가 초기화되지 않았각. 변경 사항을 불러올 수 없각.');
                changelogDisplayContent.innerHTML = '<p class="text-red-500">변경 사항을 불러올 수 없각. 데이터베이스 연결 문제일 수 있각.</p>';
                return;
            }

            const changelogDocRef = doc(db, `artifacts/${appId}/public/data/changelogs/${FIRESTORE_CHANGELOG_PATH}`);

            // Set up real-time listener for changelog
            onSnapshot(changelogDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    changelogDisplayContent.innerHTML = data.content || '<p>저장된 변경 사항이 없각.</p>';
                } else {
                    console.log("Firestore에 변경 사항 문서가 없각. 기본 내용을 사용하각.");
                    // If document doesn't exist, use default from hidden div and save it to Firestore
                    const defaultChangelog = changelogData.innerHTML;
                    changelogDisplayContent.innerHTML = defaultChangelog;
                    setDoc(changelogDocRef, { content: defaultChangelog })
                        .then(() => console.log('기본 변경 사항을 Firestore에 저장했각.'))
                        .catch(e => console.error('기본 변경 사항 저장 오류각:', e));
                }
            }, (error) => {
                console.error("변경 사항 실시간 업데이트 오류각:", error);
                changelogDisplayContent.innerHTML = `<p class="text-red-500">변경 사항 불러오기 오류각: ${error.message}</p>`;
            });
        };

        // Function to save changelog content to Firestore
        const saveChangelogContent = async (content) => {
            if (!db || !appId || !currentUserId) {
                changelogStatus.textContent = '저장 오류각: 데이터베이스 연결 문제각.';
                changelogStatus.classList.remove('hidden', 'text-green-500');
                changelogStatus.classList.add('text-red-500');
                return;
            }

            const changelogDocRef = doc(db, `artifacts/${appId}/public/data/changelogs/${FIRESTORE_CHANGELOG_PATH}`);
            try {
                await setDoc(changelogDocRef, { content: content });
                changelogStatus.textContent = '변경 사항 저장됐각!';
                changelogStatus.classList.remove('hidden', 'text-red-500');
                changelogStatus.classList.add('text-green-500');
            } catch (e) {
                console.error("Firestore 변경 사항 저장 오류각:", e);
                changelogStatus.textContent = `저장 실패각: ${e.message}`;
                changelogStatus.classList.remove('hidden', 'text-green-500');
                changelogStatus.classList.add('text-red-500');
            } finally {
                setTimeout(() => { changelogStatus.classList.add('hidden'); }, 3000);
            }
        };

        // Function to show changelog in view mode
        const showChangelogViewMode = () => {
            changelogDisplayContent.classList.remove('hidden');
            changelogAuthSection.classList.remove('hidden'); // Show auth section by default
            changelogEditSection.classList.add('hidden');
            changelogStatus.classList.add('hidden');
            changelogPasswordInput.value = ''; // Clear password input
            changelogPasswordInput.classList.remove('border-red-500'); // Remove error border
            if (quill) {
                quill.root.innerHTML = ''; // Clear Quill content when switching to view mode
            }
        };

        // Function to show changelog in edit mode
        const showChangelogEditMode = () => {
            changelogDisplayContent.classList.add('hidden');
            changelogAuthSection.classList.add('hidden');
            changelogEditSection.classList.remove('hidden');

            if (!quill) {
                quill = new Quill(changelogEditorDiv, {
                    theme: 'snow',
                    modules: {
                        toolbar: '#changelog-toolbar' // Refer to the ID of the pre-defined toolbar
                    }
                });
            }
            // Populate editor with current content from display
            quill.root.innerHTML = changelogDisplayContent.innerHTML;
            changelogStatus.classList.add('hidden'); // Hide status message
        };

        // Handle sending a message
        const handleSendMessage = async () => {
            const inputVal = userInput.value.trim();
            if (inputVal === '') return;

            addMessageToUI('user', inputVal);
            saveMessageToSessionStorage('user', inputVal);
            userInput.value = '';

            const botResponseText = await getBotResponse(inputVal);
            addMessageToUI('bot', botResponseText);
            saveMessageToSessionStorage('bot', botResponseText);
        };

        // Event Listeners
        sendButton.addEventListener('click', handleSendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSendMessage();
            }
        });

        // Toggle dropdown menu visibility
        menuButton.addEventListener('click', (event) => {
            event.stopPropagation(); // Prevent click from closing immediately
            dropdownMenu.classList.toggle('hidden');
            // Change menu button color when dropdown is active
            if (!dropdownMenu.classList.contains('hidden')) {
                menuButton.classList.remove('bg-gray-700', 'hover:bg-gray-800');
                menuButton.classList.add('bg-gray-600'); // Lighter shade when active
            } else {
                menuButton.classList.remove('bg-gray-600');
                menuButton.classList.add('bg-gray-700', 'hover:bg-gray-800');
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (event) => {
            if (!dropdownMenu.contains(event.target) && !menuButton.contains(event.target)) {
                dropdownMenu.classList.add('hidden');
                menuButton.classList.remove('bg-gray-600');
                menuButton.classList.add('bg-gray-700', 'hover:bg-gray-800');
            }
        });

        // Event listener for Changelog button
        changelogButton.addEventListener('click', () => {
            dropdownMenu.classList.add('hidden'); // Close dropdown menu
            // loadChangelogContent() is now handled by onSnapshot in initFirebase
            changelogModal.classList.remove('hidden'); // Show the modal
            showChangelogViewMode(); // Ensure it starts in view mode
        });

        // Event listener for Close Changelog button
        closeChangelogButton.addEventListener('click', () => {
            changelogModal.classList.add('hidden'); // Hide the modal
            showChangelogViewMode(); // Reset view mode and clear password on close
        });

        // Event listener for Unlock Changelog button
        unlockChangelogButton.addEventListener('click', () => {
            const enteredPassword = changelogPasswordInput.value;
            if (enteredPassword === ADMIN_PASSWORD) {
                changelogStatus.textContent = '편집 모드각!';
                changelogStatus.classList.remove('hidden', 'text-red-500');
                changelogStatus.classList.add('text-green-500');
                changelogPasswordInput.classList.remove('border-red-500'); // Remove error border
                showChangelogEditMode();
            } else {
                changelogStatus.textContent = '비밀번호 틀렸각!';
                changelogStatus.classList.remove('hidden', 'text-green-500');
                changelogStatus.classList.add('text-red-500');
                changelogPasswordInput.classList.add('border-red-500'); // Add error border
            }
            setTimeout(() => { changelogStatus.classList.add('hidden'); }, 3000);
        });

        // Event listener for Save Changelog Edits button
        saveChangelogEditsButton.addEventListener('click', () => {
            const newContent = quill.root.innerHTML; // Get HTML from Quill
            saveChangelogContent(newContent); // Save to Firestore
            // loadChangelogContent() will be triggered by onSnapshot
            showChangelogViewMode();
        });

        // Event listener for Cancel Changelog Edits button
        cancelChangelogEditsButton.addEventListener('click', () => {
            showChangelogViewMode();
            changelogStatus.textContent = '편집 취소했각!';
            changelogStatus.classList.remove('hidden', 'text-green-500');
            changelogStatus.classList.add('text-red-500');
            setTimeout(() => { changelogStatus.classList.add('hidden'); }, 3000);
        });


        // Event listener for Profile button
        profileButton.addEventListener('click', () => {
            dropdownMenu.classList.add('hidden'); // Close dropdown menu
            loadProfileFromLocalStorage(); // Load existing profile data into modal inputs
            profileModal.classList.remove('hidden'); // Show the profile modal
            profileSaveStatus.classList.add('hidden'); // Hide previous save status
        });

        // Event listener for Save Profile button
        saveProfileButton.addEventListener('click', () => {
            saveProfileToLocalStorage(); // Save profile data
        });

        // Event listener for Close Profile button
        closeProfileButton.addEventListener('click', () => {
            profileModal.classList.add('hidden'); // Hide the profile modal
        });


        resetButton.addEventListener('click', reloadPageForReset);

        // Firebase Initialization and Auth
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        const initFirebase = async () => {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Sign in anonymously or with custom token
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log('Firebase: Custom token으로 로그인했각.');
                } else {
                    await signInAnonymously(auth);
                    console.log('Firebase: 익명으로 로그인했각.');
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userIdDisplay.textContent = `사용자 ID: ${currentUserId}`;
                        console.log('Firebase: 사용자 ID 설정됐각:', currentUserId);
                        loadChangelogContent(); // Load changelog after auth
                    } else {
                        currentUserId = null;
                        userIdDisplay.textContent = '사용자 ID: 로그인 안됐각.';
                        console.log('Firebase: 사용자 로그아웃했각.');
                    }
                });
            } catch (error) {
                console.error('Firebase 초기화 또는 로그인 오류각:', error);
                userIdDisplay.textContent = `사용자 ID: 오류 (${error.message})`;
                changelogDisplayContent.innerHTML = `<p class="text-red-500">Firebase 연결 오류각: ${error.message}</p>`;
            }
        };


        // Initialize on window load
        window.onload = () => {
            console.log('각뿔봇 window.onload 실행각.');
            // Ensure modals are hidden on load
            changelogModal.classList.add('hidden');
            profileModal.classList.add('hidden');

            loadMessagesFromSessionStorage(); // Load chat history
            loadProfileFromLocalStorage(); // Load user profile
            initFirebase(); // Initialize Firebase and load changelog
        };
    </script>
</body>
</html>
